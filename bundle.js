(()=>{"use strict";(()=>{function e(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function t(e){return e[Math.floor(Math.random()*e.length)]}window.util={offerTypes:{flat:{minPrice:"1000",text:"Квартира"},house:{minPrice:"5000",text:"Дом"},palace:{minPrice:"10000",text:"Дворец"},bungalow:{minPrice:"0",text:"Бунгало"}},getRandom:e,getRandomItem:t,getRandomItems:function(n){const o=n.slice();for(let r=1;r<=e(0,n.length);r++){const e=t(o);o.splice(o.indexOf(e),1)}return o},onPrimaryMouseButtonPress:function(e,t){0===e.button&&t()},onEscPress:function(e,t){"Escape"===e.key&&t()},onEnterPress:function(e,t){"Enter"===e.key&&t()},addDocumentClick:function(e){document.addEventListener("click",(function(){e()}))}}})(),(()=>{function e(e,t,n,o,r){const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(function(){let e;switch(i.status){case 200:o(i.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e=`Cтатус ответа: ${i.status} ${i.statusText}`}e&&r(e)})),i.addEventListener("error",(function(){r("Произошла ошибка соединения")})),i.addEventListener("timeout",(function(){r(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.timeout=4e3,i.open(e,t),n?i.send(n):i.send()}window.server={load:function(t,n){e("GET","https://21.javascript.pages.academy/keksobooking/data",null,t,n)},upload:function(t,n,o){e("POST"," https://21.javascript.pages.academy/keksobooking",t,n,o)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),o=n.querySelector(".error__button");function r(){!function(){const e=document.querySelector(".success"),t=document.querySelector(".error");e?e.remove():t&&t.remove()}(),document.removeEventListener("keydown",i),document.removeEventListener("click",r)}function i(e){window.util.onEscPress(e,r)}function c(){document.addEventListener("keydown",i),document.addEventListener("click",r)}window.message={errorHandler:function(e){const t=document.createElement("div");t.style="z-index: 100; padding: 10px; margin: 0 auto; color: #fff; font-weight: 500; text-align: center; background-color: #f44336; border-radius: 4px;",t.style.position="fixed",t.style.top="5px",t.style.left="15px",t.style.right="15px",t.style.fontSize="30px",t.textContent=e,t.addEventListener("click",(function(){t.remove()})),document.addEventListener("keydown",(function(e){window.util.onEscPress(e,t.remove())})),document.body.insertAdjacentElement("afterbegin",t),window.form.filters.remove()},error:function(){e.insertAdjacentElement("afterbegin",n),o.addEventListener("click",(function(){n.remove()})),c()},success:function(){e.insertAdjacentElement("afterbegin",t),c()}}})(),(()=>{const e=document.querySelector(".map");window.map={disable:function(){e.classList.add("map--faded")},enable:function(){e.classList.remove("map--faded")}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=t.offsetHeight+10,o=Math.floor(t.offsetWidth/2);let r={min:0-o,max:e.offsetWidth-o},i={min:130-n,max:630-n};t.addEventListener("mousedown",(function(e){e.preventDefault();let o=!1,c={X:e.clientX,Y:e.clientY};function u(e){e.preventDefault(),window.card.close(),window.pin.disable(),o=!0;const u=c.X-e.clientX,s=c.Y-e.clientY;c={X:e.clientX,Y:e.clientY};let a=t.offsetTop-s,d=t.offsetLeft-u;d<=r.min?d=r.min:d>=r.max&&(d=r.max),a<=i.min?a=i.min:a>=i.max&&(a=i.max),t.style.top=a+"px",t.style.left=d+"px",window.form.fillAddress(t,n)}document.addEventListener("mousemove",u),document.addEventListener("mouseup",(function e(r){r.preventDefault(),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",e),o&&t.addEventListener("click",(function e(n){n.preventDefault(),t.removeEventListener("click",e)})),window.form.fillAddress(t,n)}))})),window.mainPin={restart:function(){t.style.top="375px",t.style.left="570px",window.form.fillAddress(t,n)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),n=e.querySelector(".map__filters-container");function o(){const e=document.querySelector(".map__card");e&&e.remove()}function r(){o(),document.removeEventListener("keydown",i)}function i(e){"Escape"===e.key&&(e.preventDefault(),r())}window.card={get:function(e){let n=t.cloneNode(!0);const o=n.querySelector(".popup__photos"),r=o.querySelector(".popup__photo"),i=n.querySelector(".popup__features"),c=n.querySelector(".popup__close");return n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__text--capacity").textContent=function(e,t){let n="";return n=0===e?"Помещение ":e%10==1&&e%100!=11?e+" комната ":e%10>1&&e%10<5&&e%100!=12&&e%100!=13&&e%100!=14?e+" комнаты ":e+" комнат ",n+=0===t?"без гостей":t%10==1&&t%100!=11?"для "+t+" гостя.":"для "+t+" гостей.",n}(e.offer.rooms,e.offer.guests),n.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,n.querySelector(".popup__description").textContent=e.offer.description,n.querySelector(".popup__avatar").src=e.author.avatar,n.querySelector(".popup__type").textContent=window.util.offerTypes[e.offer.type].text,e.offer.photos?(o.innerHTML="",e.offer.photos.forEach((e=>{const t=r.cloneNode(!0);t.src=e,o.append(t)}))):o.remove(),e.offer.features?(i.innerHTML="",e.offer.features.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),i.append(t)}))):i.remove(),c.addEventListener("click",(function(){n.remove(),window.pin.disable()})),n},create:function(t){o(),document.addEventListener("keydown",i),e.insertBefore(t,n)},close:r}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),n=t.querySelector("#housing-type"),o=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),c=t.querySelector("#housing-features");function u(t){switch(o.value){case e:return!0;case"low":return t.offer.price<1e4;case"middle":return t.offer.price>=1e4&&t.offer.price<5e4;case"high":return t.offer.price>=5e4;default:return t===o.value}}window.filter={doOffers:function(t){const o=[];for(let s=0;s<t.length;s++){const a=t[s],d=n.value===e||a.offer.type===n.value,l=r.value===e||a.offer.rooms===+r.value,f=i.value===e||a.offer.guests===+i.value,m=u(a),p=Array.from(c.querySelectorAll("input:checked")).map((function(e){return e.value})).every((function(e){return a.offer.features.includes(e)}));if(d&&l&&f&&m&&p&&o.push(a),5===o.length)break}return o}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),n=document.querySelectorAll("fieldset"),o=document.querySelector(".map__filters");function r(t){if(!t.offer)return!1;const n=e.cloneNode(!0),o=n.querySelector("img");return n.style=`left: ${t.location.x-o.width/2}px;top: ${t.location.y-o.height}px;`,o.src=t.author.avatar,o.alt=t.offer.title,n.addEventListener("click",(function(){window.card.create(window.card.get(t)),c(),n.classList.add("map__pin--active"),document.addEventListener("keydown",u)})),n}function i(e){const t=document.createDocumentFragment();let n;n=e.length<5?e.length:5;for(let o=0;o<n;o++)t.appendChild(r(e[o]));document.querySelector(".map__pins").appendChild(t)}function c(){const e=t.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}function u(e){"Escape"===e.key&&(e.preventDefault(),c())}function s(){document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}let a=[];function d(e){a=e,e.length>0&&window.form.enableItems(n),l()}function l(){s(),window.card.close(),i(window.filter.doOffers(a))}o.addEventListener("change",window.debounce(l)),window.pin={disable:c,insert:i,remove:s,update:function(){window.server.load(d,window.message.errorHandler)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__filters"),n=e.querySelector("#address"),o=e.querySelector("#room_number"),r=e.querySelector("#capacity"),i=e.querySelector("#price"),c=e.querySelector("#type"),u=e.querySelector("#timein"),s=e.querySelector("#timeout"),a=e.querySelector(".ad-form__reset"),d={1:"1 комната — для 1 гостя",2:"2 комнаты — для 2 гостей или для 1 гостя",3:"3 комнаты — для 3 гостей, или для 2 гостей, или для 1 гостя",100:"100 комнат — не для гостей"};function l(){i.setAttribute("min",window.util.offerTypes[c.value].minPrice),i.setAttribute("placeholder",window.util.offerTypes[c.value].minPrice)}function f(){const e=+r.value,t=+o.value;let n=!0;return 100===t&&0!==e||100!==t&&(e<1||e>t)?(r.setCustomValidity(d[t]),n=!1):r.setCustomValidity(""),r.reportValidity(),n}function m(e){const t=e.target;t===u?s.value=u.value:t===s&&(u.value=s.value)}function p(){l(),c.addEventListener("input",l),f(),o.addEventListener("change",f),r.addEventListener("change",f),u.addEventListener("change",m),s.addEventListener("change",m)}function w(){e.reset(),t.reset(),l(),window.message.success(),window.main.deactivatePage()}function y(){window.message.error()}e.addEventListener("submit",(function(t){t.preventDefault(),window.server.upload(new FormData(e),w,y),window.scrollTo(0,0)})),a.addEventListener("click",(function(){e.reset(),t.reset(),p(),window.main.deactivatePage(),window.scrollTo(0,0)})),window.form={filters:t,checkValidation:p,disableItems:function(e){e.forEach((e=>{e.setAttribute("disabled",!0)}))},enableItems:function(e){e.forEach((e=>{e.removeAttribute("disabled")}))},fillAddress:function(t,o){let r,i=Math.floor(parseInt(t.style.left,10)+t.clientWidth/2);r=e.classList.contains("ad-form--disabled")?Math.floor(parseInt(t.style.top,10)+t.clientHeight/2):Math.floor(parseInt(t.style.top,10)+o),n.value=`${i}, ${r}`}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),n=document.querySelectorAll("fieldset");function o(){e.removeEventListener("mousedown",i),e.removeEventListener("keydown",c)}function r(){e.addEventListener("mousedown",i),e.addEventListener("keydown",c)}function i(e){window.util.onPrimaryMouseButtonPress(e,s),o()}function c(e){window.util.onEnterEvent(e,s),o()}function u(){window.map.disable(),window.form.disableItems(n),window.pin.remove(),window.card.close(),t.classList.add("ad-form--disabled"),window.mainPin.restart(),r()}function s(){window.map.enable(),window.form.enableItems(n),t.classList.remove("ad-form--disabled"),window.pin.update()}r(),u(),window.form.checkValidation(),window.main={deactivatePage:u}})()})();